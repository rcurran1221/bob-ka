<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Notes Sender</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Responsive meta -->
  <style>
    table,
    th,
    td {
      border: 1px solid black;
      border-collapse: collapse;
      white-space: pre-wrap;
      width: 100%;
    }

    td {
      max-width: 100%;
    }

    table {
      table-layout: fixed;
      width: 97vw;
    }

    pre {
      max-width: 100%;
    }
  </style>
</head>

<body>
  <div style="display: flex;flex-direction: column;">
    <div>
      <h2> Upcoming </h2>
      <table>
        <tr>
          <td id="upcoming_latest" , style="white-space: pre-wrap;">
          </td>
        </tr>
      </table>
    </div>
    <div>
      <h2> Todo </h2>
      <table id="todo_table">
        <tr>
          <td>go to school and get good grades</td>
          <td contenteditable="true" class="todo-resolution" id="todo-x">col 2</td>
        <tr>
      </table>
      <div>
        <h2> Log </h2>
        <div id="log_table">
        </div>
        <div>
          <h2> Llm Replies</h2>
          <div id="llm_table">
          </div>
        </div>

        <script>

          function createTable(data, id) {
            let table = '<table>';

            data.forEach(item => {
              table += `<tr><td>${prettyData(item.data)}</td></tr>`;
            });

            table += '</table>';
            document.getElementById(id).innerHTML = table;
          }

          function prettyData(data) {
            if (typeof data !== 'string') {
              data = JSON.stringify(data, null, 2); // Pretty-print JSON
            }

            // Escape HTML to prevent injection
            data = data.replaceAll(/[&<>"']/g, function (match) {
              return ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;',
              })[match];
            });

            <!-- // Convert triple backtick code blocks to <pre><code> blocks -->
            data = data.replaceAll(/```(\w*)\n([\s\S]*?)```/g, function (_, lang, code) {
              return `<pre><code class="language-${lang}">${code}</code></pre>`;
            });

            data = data.replaceAll(/\n/g, '<br>');

            return data;
          }
          const resolutions = document.getElementsByClassName('todo-resolution');
          console.log(resolutions);
          for (const r of resolutions) {
            console.log(r);
          }

          const todoTable = document.getElementById('todo_table'); // Or a parent container
          todoTable.addEventListener('keydown', async event => {
            if (event.key === 'Enter') {
              console.log(event.target);

              if (event.target.className == 'todo-resolution') {
                console.log('in table cell');
                const eventData = "delete." + event.target.id;

                const response = await fetch('/produce/reminder-test', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(eventData),
                })

                console.log(response);

                if (response.status == 200) {
                  event.target.innerText = ""
                } else {
                  alert("produce delete todo event failed: " + response.status)
                }
              }
            }
          });

          // todo will be something like this?
          const url = `/peek/dashboard/1`;
          try {
            const response = fetch(url, {
              method: 'GET',
            }).then(response => {
              if (response.ok) {
                // Clear notes box on send
                console.log(response);
                response.json().then(data => {

                  console.log(data);
                  let element = document.getElementById('upcoming_latest')
                  console.log(data.events[0].data);
                  console.log(prettyData(data.events[0].data));
                  element.textContent = data.events[0].data;
                })
              }
            });

          } catch (error) {
            console.error("Error getting upcoming data", error);
          }
          try {
            const response = fetch('/peek/log/30', {
              method: 'GET',
            }).then(response => {
              if (response.ok) {
                // Clear notes box on send
                console.log(response);
                response.json().then(data => {
                  console.log(data);
                  createTable(data.events, "log_table");
                })
              }
            });

          } catch (error) {
            console.error("Error getting upcoming data", error);
          }
          try {
            const response = fetch('/peek/llm-reply/30', {
              method: 'GET',
            }).then(response => {
              if (response.ok) {
                // Clear notes box on send
                console.log(response);
                response.json().then(data => {
                  console.log(data);
                  createTable(data.events, "llm_table");
                })
              }
            });

          } catch (error) {
            console.error("Error getting upcoming data", error);
          }
        </script>
</body>

</html>