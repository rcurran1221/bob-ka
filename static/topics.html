<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Topics Grid</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    .grid-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    .grid-table th, .grid-table td { border: 1px solid #ccc; padding: 8px; }
    .grid-table th { background: #f5f5f5; }
    #paging { margin-top: 10px; }
    #topic, #sendBtn { vertical-align: middle; }
  </style>
</head>
<body>
  <label for="topic">Topic:</label>
  <input type="text" id="topic" name="topic" size="20">
  <button id="sendBtn">Send</button>

  <table class="grid-table" id="dataGrid">
    <thead>
      <!-- Filled dynamically -->
    </thead>
    <tbody>
      <!-- Filled dynamically -->
    </tbody>
  </table>

  <div id="paging">
    <button id="prevPage">Prev</button>
    <span id="pageInfo"></span>
    <button id="nextPage">Next</button>
  </div>

  <script>
    let rows = [];
    let current = 0, perPage = 5, columns = [];

    function renderTable() {
      const thead = document.querySelector('#dataGrid thead');
      const tbody = document.querySelector('#dataGrid tbody');
      // Set column headers from keys of first row
      thead.innerHTML = '';
      if (columns.length > 0) {
        thead.innerHTML = '<tr>' + columns.map(c => `<th>${c}</th>`).join('') + '</tr>';
      }
      // Rows for this page
      tbody.innerHTML = '';
      const pageRows = rows.slice(current*perPage, (current+1)*perPage);
      pageRows.forEach(row => {
        tbody.innerHTML += '<tr>' +
          columns.map(c => `<td>${JSON.stringify(row[c]) ?? ""}</td>`).join('') +
        '</tr>';
      });
      document.getElementById('pageInfo').textContent = `Page ${current+1} of ${Math.max(1, Math.ceil(rows.length/perPage))}`;
    }

    document.getElementById('prevPage').onclick = () => {
      if (current > 0) { current--; renderTable(); }
    };
    document.getElementById('nextPage').onclick = () => {
      if ((current+1)*perPage < rows.length) { current++; renderTable(); }
    };
    document.getElementById('sendBtn').onclick = async () => {
      const topic = document.getElementById('topic').value;
      const url = `/consume/${encodeURIComponent(topic)}/robc/5`;
      try {
        const resp = await fetch(url);
        if (!resp.ok) throw new Error("Failed to fetch");
        const data = await resp.json();
        // Expecting 'data' to be an array of objects
        if (Array.isArray(data.events) && data.events.length > 0 && typeof data.events[0] === 'object') {
          rows = data.events;
          columns = Object.keys(data.events[0]);
        } else if (typeof data === 'object') {
          rows = [data];
          columns = Object.keys(data);
        } else {
          rows = [];
          columns = [];
        }
        current = 0;
        renderTable();
      } catch (err) {
        alert("Error loading data: " + err);
      }
    };

    // Optionally: Initial table render
    renderTable();
  </script>
</body>
</html>
